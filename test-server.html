<!DOCTYPE html>
<html>
<head>
    <title>Test Server Connection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-box {
            border: 2px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { border-color: #4caf50; background: #f1f8f4; }
        .error { border-color: #f44336; background: #fef1f0; }
        .pending { border-color: #ff9800; background: #fff8f0; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0b7dda;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>üîß Server Connection Tester</h1>
    <p>This page tests if your backend server is running and accepting requests.</p>

    <div class="test-box pending" id="serverCheck">
        <div class="status">‚è≥ Server Status: Checking...</div>
        <button onclick="checkServer()">Check Server</button>
        <pre id="serverResult">Click "Check Server" to test connection</pre>
    </div>

    <div class="test-box pending" id="getUsersCheck">
        <div class="status">‚è≥ Get Users Endpoint: Not Tested</div>
        <button onclick="checkGetUsers()">Test GET /users</button>
        <pre id="getUsersResult">Click to test /users endpoint</pre>
    </div>

    <div class="test-box pending" id="registerCheck">
        <div class="status">‚è≥ Register User Endpoint: Not Tested</div>
        <button onclick="testRegister()">Test POST /register-user</button>
        <pre id="registerResult">Click to test user registration endpoint</pre>
    </div>

    <h2>üìã Instructions</h2>
    <ol>
        <li>Make sure your server is running: <code>node server.js</code></li>
        <li>Click each test button to verify endpoints</li>
        <li>Check the console (F12) for detailed logs</li>
        <li>If tests fail, start the server and try again</li>
    </ol>

    <script>
        async function checkServer() {
            const box = document.getElementById('serverCheck');
            const result = document.getElementById('serverResult');
            const status = box.querySelector('.status');
            
            status.textContent = '‚è≥ Server Status: Testing...';
            box.className = 'test-box pending';
            
            try {
                console.log('Testing server connection to http://localhost:3000/health');
                const response = await fetch('http://localhost:3000/health');
                
                if (response.ok) {
                    const data = await response.json();
                    status.textContent = '‚úÖ Server Status: Running';
                    box.className = 'test-box success';
                    result.textContent = 'SUCCESS!\n\n' + JSON.stringify(data, null, 2);
                    console.log('‚úÖ Server is running:', data);
                } else {
                    throw new Error(`Server returned status: ${response.status}`);
                }
            } catch (error) {
                status.textContent = '‚ùå Server Status: Not Running';
                box.className = 'test-box error';
                result.textContent = `ERROR: ${error.message}\n\nMake sure to run: node server.js`;
                console.error('‚ùå Server check failed:', error);
            }
        }

        async function checkGetUsers() {
            const box = document.getElementById('getUsersCheck');
            const result = document.getElementById('getUsersResult');
            const status = box.querySelector('.status');
            
            status.textContent = '‚è≥ Get Users Endpoint: Testing...';
            box.className = 'test-box pending';
            
            try {
                console.log('Testing GET /users endpoint');
                const response = await fetch('http://localhost:3000/users');
                
                if (response.ok) {
                    const data = await response.json();
                    status.textContent = '‚úÖ Get Users Endpoint: Working';
                    box.className = 'test-box success';
                    result.textContent = `SUCCESS! Found ${data.users.length} users\n\n` + 
                                        JSON.stringify(data.users.slice(0, 2), null, 2) + 
                                        '\n\n... (showing first 2 users)';
                    console.log('‚úÖ GET /users working:', data);
                } else {
                    throw new Error(`Server returned status: ${response.status}`);
                }
            } catch (error) {
                status.textContent = '‚ùå Get Users Endpoint: Failed';
                box.className = 'test-box error';
                result.textContent = `ERROR: ${error.message}`;
                console.error('‚ùå GET /users failed:', error);
            }
        }

        async function testRegister() {
            const box = document.getElementById('registerCheck');
            const result = document.getElementById('registerResult');
            const status = box.querySelector('.status');
            
            status.textContent = '‚è≥ Register User Endpoint: Testing...';
            box.className = 'test-box pending';
            
            // Create a test user with timestamp to ensure uniqueness
            const timestamp = Date.now();
            const testUser = {
                username: `testuser_${timestamp}`,
                email: `test_${timestamp}@example.com`,
                password: 'password123',
                displayName: 'Test User',
                role: 'user',
                permissions: {
                    canCreate: true,
                    canRead: true,
                    canUpdate: false,
                    canDelete: false,
                    canManageUsers: false,
                    canAccessReports: false,
                    canConfigureSystem: false
                }
            };
            
            try {
                console.log('Testing POST /register-user endpoint with:', testUser);
                const response = await fetch('http://localhost:3000/register-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testUser)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    status.textContent = '‚úÖ Register User Endpoint: Working';
                    box.className = 'test-box success';
                    result.textContent = `SUCCESS! User registered with ID: ${data.user.id}\n\n` + 
                                        JSON.stringify(data, null, 2);
                    console.log('‚úÖ POST /register-user working:', data);
                    alert('‚úÖ Test user created successfully! Check public/users.json');
                } else {
                    status.textContent = '‚ö†Ô∏è Register User Endpoint: Error';
                    box.className = 'test-box error';
                    result.textContent = `Server Error (${response.status}):\n\n` + 
                                        JSON.stringify(data, null, 2);
                    console.error('‚ö†Ô∏è POST /register-user error:', data);
                }
            } catch (error) {
                status.textContent = '‚ùå Register User Endpoint: Failed';
                box.className = 'test-box error';
                result.textContent = `ERROR: ${error.message}\n\nThe server might not be running or the endpoint is not configured.`;
                console.error('‚ùå POST /register-user failed:', error);
            }
        }

        // Auto-check server on page load
        window.onload = () => {
            checkServer();
        };
    </script>
</body>
</html>

